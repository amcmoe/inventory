<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://api.qrserver.com https://*.supabase.co; connect-src 'self' https://*.supabase.co; font-src 'self' data:; media-src 'self' blob:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; upgrade-insecure-requests">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>Asset Inventory</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <section class="auth-shell" id="authShell">
    <div class="panel auth-panel" id="authPanel">
      <h2>Sign In</h2>
      <p class="muted">Use email magic link for fast mobile sign-in.</p>
      <div class="grid">
        <div>
          <label for="emailInput">Email</label>
          <input id="emailInput" type="email" placeholder="name@school.org" autocomplete="email">
        </div>
        <button class="btn primary" id="sendLinkBtn">Send Magic Link</button>
      </div>
      <p class="muted" id="authMessage"></p>
    </div>
  </section>

  <div class="app" id="dashboardShell" hidden>
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <strong>IT Asset Inventory</strong>
          <span>Team workspace</span>
        </div>
      </div>

      <nav class="nav" aria-label="Primary" id="mainNav" hidden>
        <a class="active" href="./index.html"><span>Search</span></a>
        <div class="nav-group nav-group-admin" data-role-min="admin">
          <button class="nav-group-toggle" type="button" aria-expanded="false">
            <span>Admin</span>
            <span class="nav-caret" aria-hidden="true">â–¾</span>
          </button>
          <div class="nav-submenu">
            <a class="nav-subitem" href="./admin.html"><span>Asset Management</span></a>
            <a class="nav-subitem" href="./people.html"><span>User Management</span></a>
          </div>
        </div>
        <a href="./reports.html"><span>Reports</span></a>
      </nav>

      <div class="sidebar-footer"></div>
    </aside>

    <main class="main">
      <div class="topbar" id="indexTopbar" hidden>
        <div>
          <h1>Assets</h1>
          <div class="subtext">Search and manage devices.</div>
          <div class="subtext" id="userMeta"></div>
        </div>
        <div class="controls">
          <span class="remote-badge" id="remoteBadge" aria-live="polite">Remote Scanner: Idle</span>
          <span class="pending-badge" id="pendingUploadsBadge" hidden aria-live="polite">Pending Uploads: 0</span>
          <button class="bulk-icon-btn remote-scan-btn" id="remoteScanBtn" type="button" aria-label="Pair phone scanner" title="Pair Phone Scanner">
            <svg class="icon-pair" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="5" width="10" height="14" rx="2"></rect>
              <path d="M17 8h4"></path>
              <path d="M19 6v4"></path>
              <path d="M8 16h0.01"></path>
            </svg>
            <svg class="icon-disconnect" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="5" width="10" height="14" rx="2"></rect>
              <path d="M16 8l5 5"></path>
              <path d="M21 8l-5 5"></path>
              <path d="M8 16h0.01"></path>
            </svg>
          </button>
          <button class="btn" id="signOutBtn" type="button">Log Out</button>
        </div>
      </div>

      <section class="kpis" aria-label="Summary">
        <div class="kpi">
          <div class="label">Total assets</div>
          <div class="value" id="kpiTotal">0</div>
          <div class="hint">All tracked items</div>
        </div>
        <div class="kpi">
          <div class="label">Assigned</div>
          <div class="value" id="kpiAssigned">0</div>
          <div class="hint">Assigned to users</div>
        </div>
        <div class="kpi">
          <div class="label">Available</div>
          <div class="value" id="kpiAvailable">0</div>
          <div class="hint">Ready to deploy</div>
        </div>
        <div class="kpi">
          <div class="label">Needs attention</div>
          <div class="value" id="kpiAttention">0</div>
          <div class="hint">Repair / retired</div>
        </div>
      </section>

      <section class="panel" aria-label="Asset list" id="searchPanel" hidden>
        <div class="panel-header">
          <div class="controls">
            <div class="field search-field" id="searchField">
              <input id="searchInput" type="search" placeholder="Search serial, assignee, model..." autocomplete="off">
              <button class="bulk-icon-btn search-inline-scan-btn" id="scannerToggleBtn" type="button" aria-label="Start scanner" title="QR Scanner">
                <svg class="icon-scan" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 9V6a2 2 0 0 1 2-2h3" />
                  <path d="M20 9V6a2 2 0 0 0-2-2h-3" />
                  <path d="M4 15v3a2 2 0 0 0 2 2h3" />
                  <path d="M20 15v3a2 2 0 0 1-2 2h-3" />
                  <path d="M5 12h14" />
                </svg>
                <svg class="icon-stop" viewBox="0 0 24 24" aria-hidden="true">
                  <rect x="7" y="7" width="10" height="10" rx="1.5" />
                </svg>
              </button>
              <div class="scanner-stage" id="scannerStage" hidden>
                <video id="scannerVideo" autoplay playsinline muted></video>
                <canvas id="scannerCanvas" hidden></canvas>
                <div class="scanner-overlay"></div>
                <div class="scanner-hint" id="searchScannerHint">Scan QR/barcode to search</div>
              </div>
            </div>
            <div class="field small">
              <select id="statusFilter">
                <option value="">All status</option>
                <option value="available">Available</option>
                <option value="checked_out">Assigned</option>
                <option value="repair">Repair</option>
                <option value="retired">Retired</option>
              </select>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="clearFiltersBtn" type="button">Clear</button>
          </div>
        </div>

        <div class="table-wrap">
          <table role="grid" aria-label="Assets table">
            <thead>
              <tr>
                <th>Serial</th>
                <th>Model</th>
                <th>Assigned To</th>
                <th>Status</th>
                <th>Building</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="assetTbody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer" aria-label="Asset details" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-title">
        <strong id="drawerPrimary">-</strong>
        <span id="drawerSecondary">-</span>
      </div>
      <button class="btn ghost" id="closeDrawerBtn" type="button" aria-label="Close details">X</button>
    </div>
    <div class="drawer-body">
      <div id="drawerDetails"></div>
      <div class="detail">
        <div class="k">Notes</div>
        <div class="v" id="drawerNotes">-</div>
      </div>
      <div class="detail" id="drawerAssigneeEditor" hidden>
        <div class="k">Change Assignee</div>
        <div class="v">
          <input id="drawerAssigneeSearch" type="search" placeholder="Type person name...">
          <div id="drawerAssigneeSuggestions" class="suggestions" hidden></div>
          <div class="muted" id="drawerAssigneeSelected">No assignee selected</div>
          <div class="row">
            <button class="btn" id="drawerSetAssigneeBtn" type="button">Set Assignee</button>
            <button class="btn" id="drawerCreatePersonBtn" type="button" hidden>Create Person</button>
          </div>
        </div>
      </div>
      <div class="detail" id="drawerNoteEditor" hidden>
        <div class="k">Add Note</div>
        <div class="v">
          <textarea id="drawerNoteInput" rows="3" placeholder="Add note to this asset..."></textarea>
          <div class="row">
            <button class="btn" id="drawerSaveNoteBtn" type="button">Save Note</button>
          </div>
        </div>
      </div>
      <div class="detail" id="drawerDamageEditor" hidden>
        <div class="k">Record Damage</div>
        <div class="v">
          <button class="btn danger" id="drawerOpenDamageBtn" type="button">Record Damage</button>
        </div>
      </div>
    </div>
    <div class="drawer-footer">
      <button class="btn primary" id="printLabelBtn" type="button">Print Label</button>
      <button class="btn" id="editBtn" type="button">Edit</button>
      <button class="btn danger" id="retireBtn" type="button">Retire</button>
    </div>
  </aside>
  <aside class="drawer drawer-secondary" id="damageDrawer" aria-label="Record damage" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-title">
        <strong>Record Damage</strong>
        <span id="damageDrawerAssetMeta">Select an asset first</span>
      </div>
      <button class="btn ghost" id="damageDrawerCloseBtn" type="button" aria-label="Close damage drawer">X</button>
    </div>
      <div class="drawer-body">
      <div class="detail">
        <div class="k">Damage Note</div>
        <div class="v">
          <textarea id="drawerDamageNotes" rows="4" placeholder="Describe the damage..." required></textarea>
        </div>
      </div>
          <div class="detail">
        <div class="k">Photos</div>
        <div class="v">
          <div class="row damage-drawer-tools">
            <button class="bulk-icon-btn" id="drawerDamageCameraToggleBtn" type="button" aria-label="Start camera" title="Start Camera">
              <svg class="icon-scan" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7h3l1.3-2h7.4L17 7h3a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
              <svg class="icon-stop" viewBox="0 0 24 24" aria-hidden="true">
                <rect x="7" y="7" width="10" height="10" rx="1.5" />
              </svg>
            </button>
            <button class="bulk-icon-btn" id="drawerDamageUploadBtn" type="button" aria-label="Upload photos" title="Upload Photos">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 16V6"></path>
                <path d="M8.5 9.5 12 6l3.5 3.5"></path>
                <path d="M4 17.5V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1.5"></path>
              </svg>
            </button>
          </div>
          <div class="scanner-stage" id="drawerDamageCameraStage" hidden>
            <video id="drawerDamageCameraVideo" autoplay playsinline muted></video>
            <canvas id="drawerDamageCameraCanvas" hidden></canvas>
            <div class="scanner-overlay"></div>
            <button class="camera-shutter-btn" id="drawerDamageCameraCaptureBtn" type="button" aria-label="Capture photo" title="Capture Photo" disabled>
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="thumb-grid" id="drawerDamageThumbs" hidden></div>
          <input id="drawerDamagePhotos" type="file" accept="image/*" capture="environment" multiple hidden>
        </div>
      </div>
    </div>
    <div class="drawer-footer">
      <button class="btn" id="damageDrawerCancelBtn" type="button">Cancel</button>
      <button class="btn danger" id="drawerReportDamageBtn" type="button">Submit Damage Report</button>
    </div>
  </aside>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="pair-modal-overlay" id="pairModalOverlay" hidden></div>
  <section class="pair-modal" id="pairModal" hidden aria-label="Phone scanner pairing">
    <div class="pair-modal-head">
      <strong>Pair Phone Scanner</strong>
      <button class="btn ghost" id="pairModalCloseBtn" type="button" aria-label="Close pairing">X</button>
    </div>
    <div class="pair-modal-body">
      <div class="muted">Open <code>pair.html</code> on the shared phone, then scan this QR.</div>
      <canvas id="pairQrCanvas" width="220" height="220" aria-label="Pairing QR"></canvas>
      <div class="pair-status" id="pairStatus">Waiting to generate pairing...</div>
      <div class="pair-meta muted" id="pairMeta"></div>
    </div>
    <div class="pair-modal-footer">
      <button class="btn" id="pairEndSessionBtn" type="button">Cancel</button>
      <button class="btn primary" id="pairRegenerateBtn" type="button">Regenerate QR</button>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="./config.js"></script>
  <script src="./ui.js"></script>
  <script type="module" src="./js/index.js"></script>
  <button class="theme-toggle-fab" id="themeBtn" type="button" aria-label="Toggle theme">
    <span class="theme-toggle-glyph" aria-hidden="true"></span>
  </button>
</body>
</html>

